version: 2.1

jobs:

  # build:
  
  #   working_directory: /go/src/github.com/{{ORG_NAME}}/{{REPO_NAME}}/api
  
  #   docker:
  #     # specify the version
  #     - image: circleci/golang:1.9

  #   steps:
  #     - checkout
  #     - setup_remote_docker
  #     - run: 
  #         name: Installing depedencies
  #         command: go get -v -t -d ./...
  #     - run: 
  #         name: Running tests
  #         command: go test -v ./...
  #     - run: 
  #         name: Compiling
  #         command: go build
  #     - run:
  #         name: Building docker image
  #         command: docker image build -t us.gcr.io/vitaes/api:$CIRCLE_BRANCH .
  #     - run:
  #         name: Login GCR
  #         command: cat ${GCLOUD_SERVICE_KEY} | docker login -u _json_key --password-stdin https://us.gcr.io/vitaes/
  #     - run:
  #         name: Pushing docker image to gcr
  #         command: docker image push us.gcr.io/vitaes/api:$CIRCLE_BRANCH
  
  static_analysis:

    working_directory: /go/src/github.com/{{ORG_NAME}}/{{REPO_NAME}}/api
    
    docker:
      - image: fabiocorreia/sonarscanner:3.3.0-alpine

    steps:
      - checkout
      - run:
        name: running analysis
        command: |
          export SONAR_SCANNER_OPTS="-Xmx2048m"
          sonar-scanner -Dsonar.projectKey=vitaes_api \
          -Dsonar.sources=. \
          -Dsonar.sourceEncoding=UTF-8 \
          -Dsonar.exclusions= \
          -Dsonar.host.url=https://sonarqube.vitaes.tk \
          -Dsonar.projectVersion=1.0 \
          -Dsonar.login=${SONARQUBE_TOKEN}

workflows:
  version: 2
  build_test_and_deliver:
    jobs:
      - static_analysis